
class Custom_Product_List_Widget extends WP_Widget {
    // Constructor
    public function __construct() {
        parent::__construct(
            'custom_product_list_widget',
            __('Lista de productos Personalizada', 'text_domain'),
            array(
                'description' => __('Muestra una lista de productos personalizada', 'text_domain'),
            )
        );
    }

    // Función para mostrar contenido en el Frontend
    public function widget($args, $instance) {
        $selected_product = isset($instance['selected_product']) ? $instance['selected_product'] : 0;

        // Verifica si se seleccionó un producto
        if ($selected_product > 0) {
            // Guarda el producto seleccionado
            $product = wc_get_product($selected_product);

            // Verifica si el producto existe y es visible
            if (is_a($product, 'WC_Product') && $product->is_visible()) {
                // Genera el div con la clase "widget-product"
                echo '<div class="widget-product">';

                // Genera el slider con Slick
                echo '<div class="slick-slider">';
                echo '<div class="slider-items">';
                $this->render_product($product);

                // Cierra el slider
                echo '</div>';

                // Agrega los controles del slider
                echo '<div class="slider-controls">';
                echo '<button class="prev">Prev</button>';
                echo '<button class="next">Next</button>';
                echo '</div>';

                // Cierra el div "widget-product"
                echo '</div>';
                echo '</div>';

                // Encola los scripts de Slick Slider
                $this->enqueue_slick_slider();
            } else {
                echo 'Producto no válido';
            }
        } else {
            echo 'No se seleccionó ningún producto';
        }
    }

    // Función para generar el HTML de un producto
    private function render_product($product) {
        echo '<div class="slide">';
        echo '<a href="' . get_permalink($product->get_id()) . '">';
        echo '<img src="' . $product->get_image() . '" alt="' . esc_attr($product->get_name()) . '">';
        echo '<h2>' . esc_html($product->get_name()) . '</h2>';
        echo '<span class="price">' . $product->get_price_html() . '</span>';
        echo '</a>';
        echo '</div>';
    }

    // Función para encolar scripts y estilos
    private function enqueue_slick_slider() {
        // Asegúrate de que las rutas a los archivos CSS y JavaScript sean correctas
        wp_enqueue_style('slick-css', get_template_directory_uri() . '/css/slick.css');
        wp_enqueue_script('slick-js', get_template_directory_uri() . '/js/slick.min.js', array('jquery', 'slick-js'), null, true);

        // Agrega el script personalizado para el slider con carga bajo demanda
        wp_enqueue_script('widget-slider', get_template_directory_uri() . '/js/widget-slider.js', array('jquery', 'slick-js'), null, true);

        // Variables JavaScript para configurar la carga bajo demanda
        wp_localize_script('widget-slider', 'widget_slider_params', array(
            'posts_per_slide' => 5,
        ));
    }

    // Función para gestionar el formulario del widget en el backend
    public function form($instance) {
        $selected_product = isset($instance['selected_product']) ? $instance['selected_product'] : 0;
        ?>
        <p>
            <label for="<?php echo $this->get_field_id('selected_product'); ?>">Selecciona un producto de WooCommerce:</label>
            <select class="widefat" id="<?php echo $this->get_field_id('selected_product'); ?>"
                    name="<?php echo $this->get_field_name('selected_product'); ?>">
                <?php
                // Obtiene la lista de productos de WooCommerce
                $products = wc_get_products(array('limit' => -1));
                foreach ($products as $product) {
                    echo '<option value="' . esc_attr($product->get_id()) . '" ' . selected($selected_product, $product->get_id()) . '>' . esc_html($product->get_name()) . '</option>';
                }
                ?>
            </select>
        </p>
        <?php
    }

    // Función para guardar la configuración del widget
    public function update($new_instance, $old_instance) {
        $instance = array();
        $instance['selected_product'] = (!empty($new_instance['selected_product'])) ? intval($new_instance['selected_product']) : 0;
        return $instance;
    }
}

// Registra el widget personalizado
function register_custom_product_list_widget() {
    register_widget('Custom_Product_List_Widget');
}

